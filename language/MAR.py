import regex as re


def normalize(text: str) -> str:
    """
    摩洛哥阿拉伯语文本规范化流程（参考公开榜单）：
    1. 移除重音符号。
    2. 仅保留阿拉伯字母与数字，规整空格。
    3. 将东阿数字、全角数字转为半角。
    4. 统一常见方言写法。
    """
    # 去除阿拉伯语重音符号（Fatha、Damma 等）
    diacritics = r"[\u064B-\u0652]"
    text = re.sub(diacritics, "", text)

    # 仅保留阿拉伯字母与数字
    text = re.sub(r"[^\p{Arabic}0-9]+", " ", text).strip()

    # 规整多余空格
    text = re.sub(r"\s\s+", " ", text)

    """
    Hamza/Madda 等字形归一会影响语义，
    建议仅在评测阶段启用，训练语料请谨慎使用。
    """
    # text = re.sub("پ", "ب", text)
    # text = re.sub("ڤ", "ف", text)
    # text = re.sub(r"[آ]", "ا", text)
    # text = re.sub(r"[أإ]", "ا", text)
    # text = re.sub(r"[ؤ]", "و", text)
    # text = re.sub(r"[ئ]", "ي", text)
    # text = re.sub(r"[ء]", "", text)

    # 全角数字 → 半角数字
    fullwidth_digits = str.maketrans(
        "０１２３４５６７８９",
        "0123456789"
    )
    text = text.translate(fullwidth_digits)

    eastern_arabic_digits = str.maketrans(
        "٠١٢٣٤٥٦٧٨٩",
        "0123456789"
    )
    text = text.translate(eastern_arabic_digits)

    text = re.sub(r'\u0640\u0651\u0653\u0654\u0655\u061C\u066B\u066C\u0671', '', text)  
    """
    \u0640: 拉长符 tatweel
    \u0651: 重音符（辅音强调）
    \u0653: Maddah Above（长元音）
    \u0654: Hamza Above
    \u061C: 文字方向控制符
    \u0655: Hamza Below
    \u066B: 阿拉伯小数点
    \u066C: 阿拉伯千分位分隔符
    \u0671: Alif Wasla（宗教文本常见）
    """    

    # 摩洛哥方言常见变体统一（按使用频率持续扩展，长词优先）
    norm_map = {
        # 经典阿语 → 摩洛哥口语常见写法
        "إن شاء الله": "انشاءالله",
        "إن شاءالله": "انشاءالله",
        "ما شاء الله": "ماشاءالله",
        
        # 常见缩写/连音
        "والله": "واللاه", "ولا": "ولاه", "بالله": "بلااه",
        "علاش": "علاه",   # 很多转写系统写成 علاش
        "علاش": "علىاش",  # 另一种常见写法也统一
        
        # 疑问词统一
        "اشمن": "شنو", "أشمن": "شنو", "اش": "شنو",
        "اشناهو": "شنو", "اشنو": "شنو",
        "علاش": "علاه", "علا ش": "علاه",
        "فين": "فين",   # 本身就统一
        "كيفاش": "كيفاه", "كيفاش": "كيفاه",
        "كيف": "كيفاه",
        
        # 常见动词/助动词
        "غادي": "غادي",  # 保持
        "بغيت": "بغيت", "بغا": "بغى",
        "كنت": "كنت", "كان": "كان",
        
        # 人称代词后缀统一（非常常见）
        "ني": "نى", "ني ": "نى ",   # -ni → نى
        "ك": "ك",                   # -k 保持
        "ه": "ه", "ها": "ها",       # -ha
        "نا": "نا",                 # -na
        
        # 常见词变形统一（根据实际语料库频率可继续加）
        "هاد": "هاد", "هادي": "هادي",
        "دابا": "دابا", "دبا": "دابا",
        "بزاف": "بزاف", "بزاف": "بزّاف",
        "شوية": "شوية", "شويّة": "شوية",
        "واخا": "واخا", "واخا": "واخّا",
        "صافي": "صافي",
        "لالّاه": "لا",   # “لا والله” 常被写成 لالاه
        "سمح": "سمحلي", "سمحلي": "سمحلي",
        

        # ق 常被写作 گ
        "گ": "ق",

        # ڭ → ق（/g/ 的本地写法）
        "ڭ": "ق",

        # چ → ش（部分地区读作 ش）
        "چ": "ش",

        # ّ（Shadda）直接去掉
        "ّ": "",

        # 统一 Alef 写法
        "أ": "ا",
        "إ": "ا",
        "آ": "ا",

        # 圆塔（ة）→ ه
        "ة": "ه",

        # Yaa 变体
        "ى": "ي",

        # 常见 Darija 助词/短语
        "ماغاديش": "ما غاديش",
        "غادي": "غادي",
        "بزاف": "بزاف",  # 保留
        "شحال": "شحال",
        "علاش": "علاش",
        "فين": "فين",
        "عافاك": "عافاك",
    }
    
    # 按键长度倒序替换（避免短词先替换导致长词出错）
    for arabic_word, normalized in sorted(norm_map.items(), key=lambda x: len(x[0]), reverse=True):
        text = text.replace(arabic_word, normalized)

    return text


if __name__ == "__main__":
    examples = [
        "سلام، كيفاش داير؟ بغيت نخرج دابا... شنو غادي نديرو؟",
        "والله ما بغيتش نجي، علاش جيتي متأخر؟ ٣ ساعات وانا نستناك!",
        "Inchallah ghada nshri l-karhab 7mra, 2 litres dyal lmazot wakha?",
        "واش گتشوف!! هذا؟ Darija 2025 ??? بزّاف!",
        " [cough] ملكنا يا الحنين قهرونا المسؤولين.",
        "ان خوها اللي بغا يخرجها من الدار [breath] غادي نسمعو القصة ديالها.",
        "هادي ٢٠ درهم، بغيت جوج كيلو ديال الطماطم، ماشي غالية بزاف؟",
        "لا والله، صافي كملنا، سمحلي ولكن ما بغيتش هادشي"
    ]
    
    print("原始 → 标准化后\n")
    for ex in examples:
        print(f"{ex}")
        print(f"{normalize(ex)}\n")
